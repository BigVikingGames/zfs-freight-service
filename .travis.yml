language: go
sudo: required
dist: trusty

env:
  - rel=0.6.5.7

services:
  - docker

go:
  - 1.5

before_install:
  - MAKEFLAGS=-j$(($(grep -c '^processor' /proc/cpuinfo) * 2 + 1))
  - sudo apt-get update -y && sudo apt-get install -y linux-headers-$(uname -r) uuid-dev tree
  - cd /tmp
  - curl -L https://github.com/zfsonlinux/zfs/releases/download/zfs-$rel/spl-$rel.tar.gz | tar xz
  - curl -L https://github.com/zfsonlinux/zfs/releases/download/zfs-$rel/zfs-$rel.tar.gz | tar xz
  - (cd spl-$rel && ./configure --prefix=/usr && make && sudo make install)
  - (cd zfs-$rel && ./configure --prefix=/usr && make && sudo make install)
  - sudo modprobe zfs
  - cd $TRAVIS_BUILD_DIR
  - sudo apt-get update
  - sudo apt-get install -o Dpkg::Options::="--force-confold" --force-yes -y docker-engine

install:
  - go get -v -d

before_script:
  - whoami
  - docker version
  - make binary
  - chmod +x bin/zfs-freight
  - sudo ./bin/zfs-freight &
  - sudo -E bash -c 'export'

script:
  - sudo -E su root -c 'make test'

